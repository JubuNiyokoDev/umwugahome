/**
 * @fileoverview Firestore Security Rules for UmwugaHome platform.
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for user profiles and related data.
 * Artisans, Training Centers, Youths, and Mentors can only manage their own profiles. Products, Courses and Orders can be read by anyone, but only the owner can modify.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, secured by UID.
 * - /artisans/{artisanId}: Stores artisan profiles.
 * - /training-centers/{trainingCenterId}: Stores training center profiles.
 * - /mentors/{mentorId}: Stores mentor profiles.
 * - /products/{productId}: Stores product information.
 * - /courses/{courseId}: Stores course information.
 * - /orders/{orderId}: Stores order information.
 *
 * Key Security Decisions:
 * - Users can only create their own user document.
 * - Users can only read or modify their own artisan, training center, youth or mentor profiles.
 * - Products and Courses are publicly readable, but only the owner (artisan or training center) can modify.
 * - Orders can be read by anyone, but only the artisan can modify.
 * - Denormalization:  The artisanId is used on Products and Orders to simplify owner checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Root-level rule to prevent any unauthorized database-wide operations.
     * @path /databases/{database}/documents
     * @allow (create) N/A - This is a root rule; creation is not applicable here.
     * @deny (create) Any request to create at the root level.
     * @allow (get) N/A - This is a root rule; read is not applicable here.
     * @deny (get) Any request to read at the root level.
     * @allow (list) N/A - This is a root rule; list is not applicable here.
     * @deny (list) Any request to list at the root level.
     * @allow (update) N/A - This is a root rule; update is not applicable here.
     * @deny (update) Any request to update at the root level.
     * @allow (delete) N/A - This is a root rule; delete is not applicable here.
     * @deny (delete) Any request to delete at the root level.
     * @principle Prevents unauthorized access to the entire database.
     */
    match /{document=**} {
      allow read, write: if false;
    }

    /**
     * @description Enforces user-ownership for user profiles.
     * @path /databases/{database}/documents/users/{userId}
     * @allow (create) Authenticated user can create their own profile if the userId matches their auth.uid.
     * @deny (create) If the userId does not match the authenticated user's UID.
     * @allow (get) Authenticated user can get their own profile if the userId matches their auth.uid.
     * @deny (get) If the userId does not match the authenticated user's UID.
     * @allow (list) Authenticated user can list their own profile if the userId matches their auth.uid.
     * @deny (list) Listing of users collection is not permitted.
     * @allow (update) Authenticated user can update their own profile if the userId matches their auth.uid.
     * @deny (update) If the userId does not match the authenticated user's UID.
     * @allow (delete) Authenticated user can delete their own profile if the userId matches their auth.uid.
     * @deny (delete) If the userId does not match the authenticated user's UID.
     * @principle Enforces document ownership for writes and reads, validates relational integrity.
     */
    match /users/{userId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow update: if isSignedIn() && isExistingOwner(userId) && resource.data.id == userId;
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Enforces user-ownership for artisan profiles.
     * @path /databases/{database}/documents/artisans/{artisanId}
     * @allow (create) Authenticated user can create an artisan profile. Must have userId matching auth.uid.
     * @deny (create) If the userId does not match the authenticated user's UID.
     * @allow (get) Authenticated user can get their own artisan profile if the artisan's userId matches their auth.uid.
     * @deny (get) If the artisan's userId does not match the authenticated user's UID.
     * @allow (list) Anyone can list artisan profiles.
     * @allow (update) Authenticated user can update their own artisan profile if the artisan's userId matches their auth.uid.
     * @deny (update) If the artisan's userId does not match the authenticated user's UID.
     * @allow (delete) Authenticated user can delete their own artisan profile if the artisan's userId matches their auth.uid.
     * @deny (delete) If the artisan's userId does not match the authenticated user's UID.
     * @principle Enforces document ownership for writes, validates relational integrity.
     */
    match /artisans/{artisanId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwnerForArtisan(artisanId);
      allow delete: if isSignedIn() && isExistingOwnerForArtisan(artisanId);
    }

    /**
     * @description Enforces user-ownership for training center profiles.
     * @path /databases/{database}/documents/training-centers/{trainingCenterId}
     * @allow (create) Authenticated user can create a training center profile. Must have userId matching auth.uid.
     * @deny (create) If the userId does not match the authenticated user's UID.
     * @allow (get) Authenticated user can get training center profiles if the training center's userId matches their auth.uid.
     * @deny (get) If the training center's userId does not match the authenticated user's UID.
     * @allow (list) Anyone can list training center profiles.
     * @allow (update) Authenticated user can update their own training center profile if the training center's userId matches their auth.uid.
     * @deny (update) If the training center's userId does not match the authenticated user's UID.
     * @allow (delete) Authenticated user can delete their own training center profile if the training center's userId matches their auth.uid.
     * @deny (delete) If the training center's userId does not match the authenticated user's UID.
     * @principle Enforces document ownership for writes, validates relational integrity.
     */
    match /training-centers/{trainingCenterId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwnerForTrainingCenter(trainingCenterId);
      allow delete: if isSignedIn() && isExistingOwnerForTrainingCenter(trainingCenterId);
    }

    /**
     * @description Enforces user-ownership for mentor profiles.
     * @path /databases/{database}/documents/mentors/{mentorId}
     * @allow (create) Authenticated user can create a mentor profile. Must have userId matching auth.uid.
     * @deny (create) If the userId does not match the authenticated user's UID.
     * @allow (get) Authenticated user can get mentor profiles if the mentor's userId matches their auth.uid.
     * @deny (get) If the mentor's userId does not match the authenticated user's UID.
     * @allow (list) Anyone can list mentor profiles.
     * @allow (update) Authenticated user can update their own mentor profile if the mentor's userId matches their auth.uid.
     * @deny (update) If the mentor's userId does not match the authenticated user's UID.
     * @allow (delete) Authenticated user can delete their own mentor profile if the mentor's userId matches their auth.uid.
     * @deny (delete) If the mentor's userId does not match the authenticated user's UID.
     * @principle Enforces document ownership for writes, validates relational integrity.
     */
    match /mentors/{mentorId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwnerForMentor(mentorId);
      allow delete: if isSignedIn() && isExistingOwnerForMentor(mentorId);
    }

    /**
     * @description Allows public read access for products, but restricts write access to the artisan who owns the product.
     * @path /databases/{database}/documents/products/{productId}
     * @allow (create) Authenticated user can create a product. Must have artisanId.
     * @deny (create) If the artisanId is missing.
     * @allow (get) Anyone can read product profiles.
     * @allow (list) Anyone can list product profiles.
     * @allow (update) Authenticated user can update the product only if they own it (artisanId matches their UID).
     * @deny (update) If the artisanId does not match the authenticated user's UID.
     * @allow (delete) Authenticated user can delete the product only if they own it (artisanId matches their UID).
     * @deny (delete) If the artisanId does not match the authenticated user's UID.
     * @principle Allows public read, enforces document ownership for writes.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.artisanId != null;
      allow update: if isSignedIn() && isExistingOwnerForProduct(productId);
      allow delete: if isSignedIn() && isExistingOwnerForProduct(productId);
    }

    /**
     * @description Allows public read access for courses, but restricts write access to the training center who owns the course.
     * @path /databases/{database}/documents/courses/{courseId}
     * @allow (create) Authenticated user can create a course. Must have centerId.
     * @deny (create) If the centerId is missing.
     * @allow (get) Anyone can read course profiles.
     * @allow (list) Anyone can list course profiles.
     * @allow (update) Authenticated user can update the course only if they own it (centerId matches their associated Training Center).
     * @deny (update) If the centerId does not match the authenticated user's associated Training Center.
     * @allow (delete) Authenticated user can delete the course only if they own it (centerId matches their associated Training Center).
     * @deny (delete) If the centerId does not match the authenticated user's associated Training Center.
     * @principle Allows public read, enforces document ownership for writes.
     */
    match /courses/{courseId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.centerId != null;
      allow update: if isSignedIn() && isExistingOwnerForCourse(courseId);
      allow delete: if isSignedIn() && isExistingOwnerForCourse(courseId);
    }

        /**
     * @description Allows anyone to read orders, but restricts write access to the artisan who owns the order.
     * @path /databases/{database}/documents/orders/{orderId}
     * @allow (create) Authenticated user can create an order. Must have artisanId.
     * @deny (create) If the artisanId is missing.
     * @allow (get) Anyone can read order information.
     * @allow (list) Anyone can list order information.
     * @allow (update) Authenticated user can update the order only if they are the artisan who owns it.
     * @deny (update) If the user is not the artisan who owns the order.
     * @allow (delete) Authenticated user can delete the order only if they are the artisan who owns it.
     * @deny (delete) If the user is not the artisan who owns the order.
     * @principle Allows public read, enforces document ownership for writes.
     */
    match /orders/{orderId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.artisanId != null;
      allow update: if isSignedIn() && isExistingOwnerForOrder(orderId);
      allow delete: if isSignedIn() && isExistingOwnerForOrder(orderId);
    }


    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isSignedIn() && isOwner(userId) && resource != null;
    }

    function isOwnerForArtisan(artisanId) {
        return get(/databases/$(database)/documents/artisans/$(artisanId)).data.userId == request.auth.uid;
    }

    function isExistingOwnerForArtisan(artisanId) {
        return isSignedIn() && resource != null && isOwnerForArtisan(artisanId);
    }

     function isOwnerForTrainingCenter(trainingCenterId) {
        return get(/databases/$(database)/documents/training-centers/$(trainingCenterId)).data.userId == request.auth.uid;
    }

    function isExistingOwnerForTrainingCenter(trainingCenterId) {
        return isSignedIn() && resource != null && isOwnerForTrainingCenter(trainingCenterId);
    }

    function isOwnerForMentor(mentorId) {
        return get(/databases/$(database)/documents/mentors/$(mentorId)).data.userId == request.auth.uid;
    }

    function isExistingOwnerForMentor(mentorId) {
        return isSignedIn() && resource != null && isOwnerForMentor(mentorId);
    }

    function isOwnerForProduct(productId) {
        return get(/databases/$(database)/documents/products/$(productId)).data.artisanId == request.auth.uid;
    }

    function isExistingOwnerForProduct(productId) {
        return isSignedIn() && resource != null && isOwnerForProduct(productId);
    }

    function isOwnerForCourse(courseId) {
        return get(/databases/$(database)/documents/courses/$(courseId)).data.centerId == request.auth.uid;
    }

    function isExistingOwnerForCourse(courseId) {
        return isSignedIn() && resource != null && isOwnerForCourse(courseId);
    }

    function isOwnerForOrder(orderId) {
        return get(/databases/$(database)/documents/orders/$(orderId)).data.artisanId == request.auth.uid;
    }

    function isExistingOwnerForOrder(orderId) {
        return isSignedIn() && resource != null && isOwnerForOrder(orderId);
    }
  }
}