/**
 * @fileoverview Firestore Security Rules for UmwugaHome platform.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for profile data (artisans, training centers, youths, mentors).
 * Products and programs are owned by artisans and training centers, respectively, and orders are secured with customer/artisan ownership.
 *
 * Data Structure:
 * - /users/{userId}: Stores core user information; access is restricted to the user themselves.
 * - /users/{userId}/{profileType}: Subcollections for artisan, training center, youth, and mentor profiles, owned by the user.
 * - /users/{userId}/artisan/products/{productId}: Products are stored under the artisan's profile.
 * - /users/{userId}/training_center/programs/{programId}: Programs are stored under the training center's profile.
 * - /orders/{orderId}: Orders are stored at the top level, containing customerId and artisanId.
 *
 * Key Security Decisions:
 * - User listing is explicitly denied to protect user privacy.
 * - Strict ownership is enforced for all profile-related data.
 * - Orders can only be created, updated, and deleted by either the customer or the artisan involved.
 * - No complex data validation is enforced (prototyping mode); focus is on authorization.
 *
 * Denormalization for Authorization:
 * - The data structure inherently denormalizes ownership by nesting profile data under /users/{userId}.
 * - Orders store both artisanId and customerId, allowing for efficient authorization checks without additional reads.
 *
 * Structural Segregation:
 * - User profiles are stored in private user subcollections, while orders are top-level.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description: Secure root access.  Forces explicit collection access.
     * @path: /databases/{database}/documents
     * @allow: N/A
     * @deny: Any request to the root path.
     * @principle: Secures the database root, preventing accidental open access.
     */
    match /{document=**} {
      allow read, write: if false;
    }

    /**
     * @description: Manages user profile access.
     * @path: /users/{userId}
     * @allow: (get, create, update, delete) User with matching UID.
     * @deny: (get, create, update, delete) User with non-matching UID.
     * @principle: Enforces user-ownership for profile data.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }

      allow get: if isOwner(userId);
      allow list: if false; // User listing is not permitted.
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);

      match /{profileType} {
          allow get: if isOwner(userId);
          allow list: if false;
          allow create: if isSignedIn() && isOwner(userId);
          allow update: if isSignedIn() && isOwner(userId);
          allow delete: if isSignedIn() && isOwner(userId);

          match /products/{productId} {
            allow get: if isOwner(userId);
            allow list: if false;
            allow create: if isSignedIn() && isOwner(userId);
            allow update: if isSignedIn() && isOwner(userId);
            allow delete: if isSignedIn() && isOwner(userId);
          }
          match /programs/{programId} {
            allow get: if isOwner(userId);
            allow list: if false;
            allow create: if isSignedIn() && isOwner(userId);
            allow update: if isSignedIn() && isOwner(userId);
            allow delete: if isSignedIn() && isOwner(userId);
          }
        }
    }


    /**
     * @description: Manages order access. Orders are accessible by both the customer and the artisan.
     * @path: /orders/{orderId}
     * @allow: (get) Any authenticated user.
     * @allow: (create) Authenticated user if they are the customer.
     * @allow: (update, delete) Authenticated user if they are the customer or the artisan.
     * @deny: (create) If not the customer.
     * @deny: (update, delete) If not the customer or artisan.
     * @principle: Allows customers and artisans to manage orders related to them.
     */
    match /orders/{orderId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isCustomer(customerId) {
        return request.auth.uid == customerId;
      }
      function isArtisan(artisanId) {
        return request.auth.uid == artisanId;
      }
      function isCustomerOrArtisan(customerId, artisanId) {
        return isCustomer(customerId) || isArtisan(artisanId);
      }
      function isExistingCustomerOrArtisan(customerId, artisanId) {
        return isCustomerOrArtisan(customerId, artisanId) && exists(resource);
      }

      allow get: if isSignedIn();
      allow list: if false; // Listing orders is not generally permitted for all users. Specific order listing logic may be implemented elsewhere.
      allow create: if isSignedIn() && request.resource.data.customerId == request.auth.uid;
      allow update: if isSignedIn() && (resource.data.customerId == request.auth.uid || resource.data.artisanId == request.auth.uid);
      allow delete: if isSignedIn() && (resource.data.customerId == request.auth.uid || resource.data.artisanId == request.auth.uid);
    }
  }
}