/**
 * @fileoverview Firestore Security Rules for UmwugaHome platform.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user profiles and related data,
 * while allowing public read access to certain collections like products and courses.
 * All write operations are protected by authorization checks based on user authentication and roles.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, with userId matching the Firebase auth UID.
 * - /artisans/{artisanId}, /training-centers/{centerId}, /mentors/{mentorId}: Stores profile information for artisans, training centers, and mentors respectively.
 * - /products/{productId}, /courses/{courseId}, /orders/{orderId}: Stores product, course, and order information respectively.
 *
 * Key Security Decisions:
 * - User profiles are only readable and writable by the authenticated user.
 * - Products and courses are publicly readable but only writable by authenticated artisans and training centers respectively.
 * - Orders can be created by any authenticated user.
 * - Listing of users is disallowed for privacy reasons.
 *
 * Denormalization for Authorization:
 * - The artisanId field in the /products collection is crucial for authorizing product creation, updates, and deletions.
 * - The centerId field in the /courses collection is crucial for authorizing course creation, updates, and deletions.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
    /**
     * @description Secure user profiles.  Only the authenticated user can read/write their own profile.
     * @path /databases/{database}/documents/users/{userId}
     * @allow (get, update, delete) User with UID 'user123' can read/write their own profile at /users/user123.
     * @allow (create) User with UID 'user123' can create their own profile at /users/user123.
     * @deny (get) User with UID 'user456' cannot read the profile of user 'user123' at /users/user123.
     * @deny (update) User with UID 'user456' cannot update the profile of user 'user123' at /users/user123.
     * @deny (delete) User with UID 'user456' cannot delete the profile of user 'user123' at /users/user123.
     * @principle Enforces document ownership for all operations on user profiles.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secure artisan profiles. Only the authenticated user can read/write their own profile.
     * @path /databases/{database}/documents/artisans/{artisanId}
     * @allow (get, update, delete) User with UID 'user123' can read/write their own profile at /artisans/artisan123 if user123 is the artisan's userId.
     * @allow (create) User with UID 'user123' can create their own profile at /artisans/artisan123 if user123 is the artisan's userId.
     * @deny (get) User with UID 'user456' cannot read the profile of artisan 'artisan123' at /artisans/artisan123.
     * @deny (update) User with UID 'user456' cannot update the profile of artisan 'artisan123' at /artisans/artisan123.
     * @deny (delete) User with UID 'user456' cannot delete the profile of artisan 'artisan123' at /artisans/artisan123.
     * @principle Enforces document ownership for all operations on artisan profiles.
     */
    match /artisans/{artisanId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid && request.resource.data.id == artisanId;
      allow update: if isExistingOwner(resource.data.userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(resource.data.userId);
    }

    /**
     * @description Secure training center profiles. Only the authenticated user can read/write their own profile.
     * @path /databases/{database}/documents/training-centers/{centerId}
     * @allow (get, update, delete) User with UID 'user123' can read/write their own profile at /training-centers/center123 if user123 is the training center's userId.
     * @allow (create) User with UID 'user123' can create their own profile at /training-centers/center123 if user123 is the training center's userId.
     * @deny (get) User with UID 'user456' cannot read the profile of training center 'center123' at /training-centers/center123.
     * @deny (update) User with UID 'user456' cannot update the profile of training center 'center123'.
     * @deny (delete) User with UID 'user456' cannot delete the profile of training center 'center123'.
     * @principle Enforces document ownership for all operations on training center profiles.
     */
    match /training-centers/{centerId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid && request.resource.data.id == centerId;
      allow update: if isExistingOwner(resource.data.userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(resource.data.userId);
    }

    /**
     * @description Secure mentor profiles. Only the authenticated user can read/write their own profile.
     * @path /databases/{database}/documents/mentors/{mentorId}
     * @allow (get, update, delete) User with UID 'user123' can read/write their own profile at /mentors/mentor123 if user123 is the mentor's userId.
     * @allow (create) User with UID 'user123' can create their own profile at /mentors/mentor123 if user123 is the mentor's userId.
     * @deny (get) User with UID 'user456' cannot read the profile of mentor 'mentor123' at /mentors/mentor123.
     * @deny (update) User with UID 'user456' cannot update the profile of mentor 'mentor123'.
     * @deny (delete) User with UID 'user456' cannot delete the profile of mentor 'mentor123'.
     * @principle Enforces document ownership for all operations on mentor profiles.
     */
    match /mentors/{mentorId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid && request.resource.data.id == mentorId;
      allow update: if isExistingOwner(resource.data.userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(resource.data.userId);
    }

    /**
     * @description Secure products. Publicly readable, but only the owning artisan can create, update, or delete.
     * @path /databases/{database}/documents/products/{productId}
     * @allow (get, list) Any user can read any product.
     * @allow (create) User with UID 'user123' can create a product at /products/product123 if they are an artisan and the product's artisanId matches their UID.
     * @allow (update, delete) User with UID 'user123' can update/delete a product at /products/product123 if they are the artisan who owns the product (product.artisanId == user123).
     * @deny (create) User with UID 'user456' cannot create a product for artisan 'user123'.
     * @deny (update, delete) User with UID 'user456' cannot update/delete a product owned by artisan 'user123'.
     * @principle Public read access with owner-only writes.
     */
    match /products/{productId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.artisanId == request.auth.uid && request.resource.data.id == productId;
      allow update: if isSignedIn() && resource != null && resource.data.artisanId == request.auth.uid && request.resource.data.artisanId == resource.data.artisanId;
      allow delete: if isSignedIn() && resource != null && resource.data.artisanId == request.auth.uid;
    }

    /**
     * @description Secure courses. Publicly readable, but only the owning training center can create, update, or delete.
     * @path /databases/{database}/documents/courses/{courseId}
     * @allow (get, list) Any user can read any course.
     * @allow (create) User with UID 'user123' can create a course at /courses/course123 if they are a training center and the course's centerId matches their UID.
     * @allow (update, delete) User with UID 'user123' can update/delete a course at /courses/course123 if they are the training center who owns the course (course.centerId == user123).
     * @deny (create) User with UID 'user456' cannot create a course for training center 'user123'.
     * @deny (update, delete) User with UID 'user456' cannot update/delete a course owned by training center 'user123'.
     * @principle Public read access with owner-only writes.
     */
    match /courses/{courseId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.centerId == request.auth.uid && request.resource.data.id == courseId;
      allow update: if isSignedIn() && resource != null && resource.data.centerId == request.auth.uid && request.resource.data.centerId == resource.data.centerId;
      allow delete: if isSignedIn() && resource != null && resource.data.centerId == request.auth.uid;
    }

    /**
     * @description Secure orders. Any signed-in user can create an order. Only the artisan who owns the order can update or delete it.
     * @path /databases/{database}/documents/orders/{orderId}
     * @allow (create) Any signed-in user can create an order.
     * @allow (get, list) Any signed-in user can read any order.
     * @allow (update, delete) User with UID 'user123' can update/delete an order at /orders/order123 if they are the artisan associated with the order (order.artisanId == user123).
     * @deny (update, delete) User with UID 'user456' cannot update/delete an order associated with artisan 'user123'.
     * @principle Allows order creation by any user, but restricts updates/deletions to the owning artisan.
     */
    match /orders/{orderId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.id == orderId;
      allow update: if isSignedIn() && resource != null && resource.data.artisanId == request.auth.uid;
      allow delete: if isSignedIn() && resource != null && resource.data.artisanId == request.auth.uid;
    }
  }
}