/**
 * @file Firestore Security Rules
 * @description This ruleset allows public read access to the 'artisans' collection,
 * while restricting write access to authenticated users only. All other collections
 * are secured based on user ownership.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, secured with owner-only access.
 * - /artisans/{artisanId}: Stores artisan profiles, publicly readable but writeable by authenticated users.
 * - /training-centers/{trainingCenterId}: Stores training center profiles, secured with owner-only access.
 * - /products/{productId}: Stores product information, secured with owner-only access.
 * - /courses/{courseId}: Stores course information, secured with owner-only access.
 * - /orders/{orderId}: Stores order information, secured with owner-only access.
 *
 * Key Security Decisions:
 * - The 'artisans' collection is publicly readable.
 * - All write operations (create, update, delete) require user authentication, except for read-only collections.
 * - Standard CRUD operations are protected by the `isSignedIn()` function, ensuring that only authenticated users can modify data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the document.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is the existing owner of the document.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
    
    /**
     * @description Rules for the 'users' collection.
     * @path /databases/{database}/documents/users/{userId}
     * @allow (create) User with UID 'user123' creates their profile document.
     *  request.auth.uid == 'user123'
     *  request.resource.data.id == 'user123'
     * @allow (get, update, delete) User with UID 'user123' reads/updates/deletes their profile document.
     *  request.auth.uid == 'user123'
     * @deny (create) User with UID 'user456' attempts to create a profile document for user 'user123'.
     *  request.auth.uid == 'user456'
     *  request.resource.data.id == 'user123'
     * @principle Enforces document ownership for all operations on user profiles.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Prevent listing of all users

      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the 'artisans' collection.
     * @path /databases/{database}/documents/artisans/{artisanId}
     * @allow (get, list) Any user can read artisan profiles.
     * @allow (create, update, delete) Authenticated users can create, update, and delete artisan profiles.
     * @deny (create, update, delete) Unauthenticated users cannot create, update, and delete artisan profiles.
     * @principle Allows public read access but restricts write access to authenticated users.
     */
    match /artisans/{artisanId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rules for the 'training-centers' collection.
     * @path /databases/{database}/documents/training-centers/{trainingCenterId}
     * @allow (create) User with UID 'user123' creates a training center with id 'trainingCenter123'.
     *  request.auth.uid == 'user123'
     *  request.resource.data.userId == 'user123'
     * @allow (get, update, delete) User with UID 'user123' reads/updates/deletes training center 'trainingCenter123'.
     *  request.auth.uid == 'user123'
     *  resource.data.userId == 'user123'
     * @deny (create) User with UID 'user456' attempts to create a training center with userId 'user123'.
     *  request.auth.uid == 'user456'
     *  request.resource.data.userId == 'user123'
     * @principle Enforces document ownership for all operations on training center profiles.
     */
    match /training-centers/{trainingCenterId} {
        allow get: if isSignedIn();
        allow list: if isSignedIn();

        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
        allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

        /**
     * @description Rules for the 'products' collection.
     * @path /databases/{database}/documents/products/{productId}
     * @allow (create) User with UID 'user123' creates a product with artisanId related to user123.
     *  request.auth.uid == 'user123'
     *  request.resource.data.artisanId == 'artisan123'
     * @allow (get, update, delete) User with UID 'user123' reads/updates/deletes product related to user123.
     *  request.auth.uid == 'user123'
     *  resource.data.artisanId == 'artisan123'
     * @deny (create) User with UID 'user456' attempts to create a product with artisanId related to user123.
     *  request.auth.uid == 'user456'
     *  request.resource.data.artisanId == 'artisan123'
     * @principle Enforces document ownership for all operations on product.
     */
    match /products/{productId} {
        allow get: if isSignedIn();
        allow list: if isSignedIn();

        allow create: if isSignedIn() && request.resource.data.artisanId != null;
        allow update: if isSignedIn() && resource.data.artisanId != null;
        allow delete: if isSignedIn() && resource.data.artisanId != null;
    }

    /**
     * @description Rules for the 'courses' collection.
     * @path /databases/{database}/documents/courses/{courseId}
     * @allow (create) User with UID 'user123' creates a course with centerId related to user123.
     *  request.auth.uid == 'user123'
     *  request.resource.data.centerId == 'center123'
     * @allow (get, update, delete) User with UID 'user123' reads/updates/deletes courses related to user123.
     *  request.auth.uid == 'user123'
     *  resource.data.centerId == 'center123'
     * @deny (create) User with UID 'user456' attempts to create a course with centerId related to user123.
     *  request.auth.uid == 'user456'
     *  request.resource.data.centerId == 'center123'
     * @principle Enforces document ownership for all operations on courses.
     */
    match /courses/{courseId} {
        allow get: if isSignedIn();
        allow list: if isSignedIn();

        allow create: if isSignedIn() && request.resource.data.centerId != null;
        allow update: if isSignedIn() && resource.data.centerId != null;
        allow delete: if isSignedIn() && resource.data.centerId != null;
    }
    /**
     * @description Rules for the 'orders' collection.
     * @path /databases/{database}/documents/orders/{orderId}
     * @allow (create) User with UID 'user123' creates a order with artisanId related to user123.
     *  request.auth.uid == 'user123'
     *  request.resource.data.artisanId == 'artisan123'
     * @allow (get, update, delete) User with UID 'user123' reads/updates/deletes orders related to user123.
     *  request.auth.uid == 'user123'
     *  resource.data.artisanId == 'artisan123'
     * @deny (create) User with UID 'user456' attempts to create a order with artisanId related to user123.
     *  request.auth.uid == 'user456'
     *  request.resource.data.artisanId == 'artisan123'
     * @principle Enforces document ownership for all operations on orders.
     */
    match /orders/{orderId} {
        allow get: if isSignedIn();
        allow list: if isSignedIn();

        allow create: if isSignedIn() && request.resource.data.artisanId != null;
        allow update: if isSignedIn() && resource.data.artisanId != null;
        allow delete: if isSignedIn() && resource.data.artisanId != null;
    }
  }
}