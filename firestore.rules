/**
 * @description This ruleset enforces a strict user-ownership model for user profiles and their associated data (artisans, training centers, youths, mentors, products, and programs).
 * All data is nested under /users/{userId}, providing path-based ownership. Orders are stored at the top level but include customerId for filtering.
 * @dataStructure
 * - /users/{userId}: Stores user profile information, using the user's UID as the document ID.
 * - /users/{userId}/artisan: Stores artisan profile data linked to the user.
 * - /users/{userId}/training_center: Stores training center profile data linked to the user.
 * - /users/{userId}/youth: Stores youth profile data linked to the user.
 * - /users/{userId}/mentor: Stores mentor profile data linked to the user.
 * - /users/{userId}/artisan/products/{productId}: Stores product information for a specific artisan.
 * - /users/{userId}/training_center/programs/{programId}: Stores program information for a specific training center.
 * - /orders/{orderId}: Stores order information, including artisanId and customerId.
 * @keySecurityDecisions
 * - User listing is disallowed for privacy.
 * - All write operations are protected by authorization checks based on ownership.
 * - Read operations on the "artisans" collection are allowed for all users
 * @denormalizationForAuthorization
 * - No denormalization is explicitly required as the data structure leverages path-based ownership. The userId is inherently available in the path.
 * @structuralSegregation
 * - User profiles and related data are stored under /users/{userId} for private access.
 * - Orders are stored in a top-level collection to facilitate more open queries while still enabling filtering by artisan or customer.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Controls access to user profile documents.
     * @path /users/{userId}
     * @allow (create) User with UID 'user123' can create their profile if request.auth.uid == 'user123'.
     * @deny (create) User with UID 'user456' cannot create a profile with document ID 'user123'.
     * @allow (get) User with UID 'user123' can read their profile.
     * @allow (list) User with UID 'user123' cannot list all users. Listing is denied for privacy.
     * @allow (update) User with UID 'user123' can update their own profile.
     * @allow (delete) User with UID 'user123' can delete their own profile.
     * @principle Enforces document ownership for writes and restricts listing for privacy.
     */
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to artisan profile documents.
     * @path /users/{userId}/artisan
     * @allow (create) User with UID 'user123' can create their artisan profile under /users/user123/artisan.
     * @deny (create) User with UID 'user456' cannot create an artisan profile under /users/user123/artisan.
     * @allow (get) User with UID 'user123' can read their artisan profile.
     * @allow (list) User with UID 'user123' can list their own artisan profiles.
     * @allow (update) User with UID 'user123' can update their own artisan profile.
     * @allow (delete) User with UID 'user123' can delete their own artisan profile.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/artisan {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to training center profile documents.
     * @path /users/{userId}/training_center
     * @allow (create) User with UID 'user123' can create their training center profile under /users/user123/training_center.
     * @deny (create) User with UID 'user456' cannot create a training center profile under /users/user123/training_center.
     * @allow (get) User with UID 'user123' can read their training center profile.
     * @allow (list) User with UID 'user123' can list their training center profiles.
     * @allow (update) User with UID 'user123' can update their own training center profile.
     * @allow (delete) User with UID 'user123' can delete their own training center profile.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/training_center {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to youth profile documents.
     * @path /users/{userId}/youth
     * @allow (create) User with UID 'user123' can create their youth profile under /users/user123/youth.
     * @deny (create) User with UID 'user456' cannot create a youth profile under /users/user123/youth.
     * @allow (get) User with UID 'user123' can read their youth profile.
     * @allow (list) User with UID 'user123' can list their youth profiles.
     * @allow (update) User with UID 'user123' can update their own youth profile.
     * @allow (delete) User with UID 'user123' can delete their own youth profile.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/youth {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to mentor profile documents.
     * @path /users/{userId}/mentor
     * @allow (create) User with UID 'user123' can create their mentor profile under /users/user123/mentor.
     * @deny (create) User with UID 'user456' cannot create a mentor profile under /users/user123/mentor.
     * @allow (get) User with UID 'user123' can read their mentor profile.
     * @allow (list) User with UID 'user123' can list their mentor profiles.
     * @allow (update) User with UID 'user123' can update their own mentor profile.
     * @allow (delete) User with UID 'user123' can delete their own mentor profile.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/mentor {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to product documents under an artisan's profile.
     * @path /users/{userId}/artisan/products/{productId}
     * @allow (create) User with UID 'user123' can create a product under their artisan profile.
     * @deny (create) User with UID 'user456' cannot create a product under /users/user123/artisan/products/{productId}.
     * @allow (get) User with UID 'user123' can read a product under their artisan profile.
     * @allow (list) User with UID 'user123' can list products under their own artisan profile.
     * @allow (update) User with UID 'user123' can update a product under their artisan profile.
     * @allow (delete) User with UID 'user123' can delete a product under their artisan profile.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/artisan/products/{productId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to program documents under a training center's profile.
     * @path /users/{userId}/training_center/programs/{programId}
     * @allow (create) User with UID 'user123' can create a program under their training center profile.
     * @deny (create) User with UID 'user456' cannot create a program under /users/user123/training_center/programs/{programId}.
     * @allow (get) User with UID 'user123' can read a program under their training center profile.
     * @allow (list) User with UID 'user123' can list programs under their own training center profile.
     * @allow (update) User with UID 'user123' can update a program under their training center profile.
     * @allow (delete) User with UID 'user123' can delete a program under their training center profile.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/training_center/programs/{programId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to order documents.
     * @path /orders/{orderId}
     * @allow (create) Any authenticated user can create an order.
     * @deny (create) Unauthenticated users cannot create an order.
     * @allow (get) Any authenticated user can read an order.
     * @allow (list) Any authenticated user can list orders.
     * @allow (update) Only the user who created the order (customerId) or the artisan (artisanId) can update the order.
     * @allow (delete) Only the user who created the order (customerId) or the artisan (artisanId) can delete the order.
     * @principle Allows orders to be created by any signed-in user but restricts updates and deletes to the customer and artisan involved.
     */
    match /orders/{orderId} {
        allow get: if isSignedIn();
        allow list: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn() && (request.auth.uid == resource.data.customerId || request.auth.uid == resource.data.artisanId) && resource != null;
        allow delete: if isSignedIn() && (request.auth.uid == resource.data.customerId || request.auth.uid == resource.data.artisanId) && resource != null;
    }

    /**
     * @description Controls access to artisan documents at the top level
     * @path /artisans
     * @allow (get) Any user can get an artisan
     * @allow (list) Any user can list all artisans.
     * @deny (create) No user can create artisans at the top level.
     * @deny (update) No user can update artisans at the top level.
     * @deny (delete) No user can delete artisans at the top level.
     * @principle Artisans are public. Write actions are denied as they should be created under the user profile.
     */
    match /artisans {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}