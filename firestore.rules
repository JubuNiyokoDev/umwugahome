/**
 * @file Firebase Security Rules for UmwugaHome Platform
 *
 * @corePhilosophy This ruleset enforces a strict user-ownership model for user profiles and associated data (artisans, training centers, youths, mentors), ensuring that only the authenticated user can manage their own profile information. Public read access is allowed for top-level collections like `training-centers` to facilitate discovery, while writes are restricted to authorized users. Data validation is relaxed during this prototyping phase, focusing primarily on validating the integrity of relational links (e.g., `userId` in subcollections must match the authenticated user's UID).
 * @dataStructure User data is nested under `/users/{userId}`. Artisan, TrainingCenter, Youth and Mentor profiles are stored as subcollections of the user's document. Products and Programs are nested under their respective owner (Artisan/TrainingCenter) profile subcollections. Orders are stored in a top-level collection.
 * @keySecurityDecisions
 *   - User listing is disallowed.
 *   - Path-based ownership is enforced for all user-profile related data.
 *   - Top-level `training-centers` collection allows public reads but requires authentication for writes.
 * @denormalization For authorization, the userId is both part of the path and stored within the document itself.
 * @structuralSegregation Public data (like training center listings) and private data (user profiles) are stored in separate collections to allow for different access control policies.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user's ID matches the userId and the resource exists.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }


    /**
     * @description Enforces that the incoming data has userId equal to auth.uid.
     */
    function isValidNewUser() {
      return request.resource.data.id == request.auth.uid;
    }

    /**
     * @description Enforces that the userId field cannot be changed after creation.
     */
    function isUserIdUnchanged() {
      return request.resource.data.id == resource.data.id;
    }

    /**
     * @description Rules for the /users/{userId} collection.
     * @path /users/{userId}
     * @allow (create) User with UID 'user123' creates their profile: auth.uid == 'user123', request.resource.data.id == 'user123'
     * @deny (create) User with UID 'user123' attempts to create a profile for 'user456': auth.uid == 'user123', request.resource.data.id == 'user456'
     * @deny (update) User attempts to update a profile that doesn't exist.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // User listing is not allowed.
      allow create: if isOwner(userId) && isValidNewUser();
      allow update: if isExistingOwner(userId) && isUserIdUnchanged();
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the /users/{userId}/artisan collection.
     * @path /users/{userId}/artisan
     * @allow (create) User with UID 'user123' creates their artisan profile: auth.uid == 'user123'
     * @deny (update) User attempts to update a profile that doesn't exist.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/artisan {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the /users/{userId}/training_center collection.
     * @path /users/{userId}/training_center
     * @allow (create) User with UID 'user123' creates their training center profile: auth.uid == 'user123'
     * @deny (update) User attempts to update a profile that doesn't exist.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/training_center {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the /users/{userId}/youth collection.
     * @path /users/{userId}/youth
     * @allow (create) User with UID 'user123' creates their youth profile: auth.uid == 'user123'
     * @deny (update) User attempts to update a profile that doesn't exist.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/youth {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the /users/{userId}/mentor collection.
     * @path /users/{userId}/mentor
     * @allow (create) User with UID 'user123' creates their mentor profile: auth.uid == 'user123'
     * @deny (update) User attempts to update a profile that doesn't exist.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/mentor {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the /users/{userId}/artisan/products/{productId} collection.
     * @path /users/{userId}/artisan/products/{productId}
     * @allow (create) User with UID 'user123' creates a product under their artisan profile: auth.uid == 'user123'
     * @deny (update) User attempts to update a product that doesn't exist.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/artisan/products/{productId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the /orders/{orderId} collection.
     * @path /orders/{orderId}
     * @allow (create) Authenticated user creates an order.
     * @deny (update) User attempts to update an order that doesn't exist.
     * @principle Authenticated users can create orders; existing orders can only be modified or deleted by authorized users.  // TODO: Add more specific role-based access controls for order management in the future
     */
    match /orders/{orderId} {
      allow get: if true; // TODO: Consider more restrictive read access based on customerId or artisanId
      allow list: if true; // TODO: Consider more restrictive read access based on customerId or artisanId
      allow create: if isSignedIn();
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Rules for the /users/{userId}/training_center/programs/{programId} collection.
     * @path /users/{userId}/training_center/programs/{programId}
     * @allow (create) User with UID 'user123' creates a program under their training center profile: auth.uid == 'user123'
     * @deny (update) User attempts to update a program that doesn't exist.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/training_center/programs/{programId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

      /**
       * @description Rules for the /training-centers collection.
       * @path /training-centers
       * @allow (list) Any user can list training centers.
       * @principle Public read access, authenticated write access.
       */
      match /training-centers {
        allow get: if true;
        allow list: if true;
        allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
        allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
        allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      }
  }
}