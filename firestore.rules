/**
 * @file Firestore Security Rules for UmwugaHome Platform
 * @core_philosophy This ruleset enforces a strict user-ownership model where users can only create, read, update, and delete their own data.
 *  For resources not owned by a user (e.g., products), write access is restricted to the owner (artisan).
 * @data_structure The data is organized into top-level collections: `users`, `artisans`, `training-centers`, `mentors`, `products`, `courses`, and `orders`.
 *  Each collection contains documents representing entities.
 * @key_security_decisions
 *  - Users can only manage their own profile data in the `users` collection.
 *  - Artisans manage their products.
 *  - Training centers manage their courses.
 *  - Listing of users is disallowed.
 *  - Data shape validation is relaxed to allow for rapid iteration.
 * @denormalization The artisanId is denormalized in the `products` collection to allow for easy association of products with their respective artisans and secure write operations.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profiles. Users can only manage their own profile data.
     * @path /databases/{database}/documents/users/{userId}
     * @allow (create) Authenticated user with matching userId in document data.
     * @allow (get, update, delete) Authenticated user with a matching userId.
     * @deny (create) If the userId in the request does not match the authenticated user's ID.
     * @deny (get, update, delete) If the userId does not match the authenticated user's ID.
     * @principle Enforces document ownership for writes and restricts access to a user's own data.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false; // Listing users is not permitted.
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to artisan profiles. Artisans can manage their own profiles.
     * @path /databases/{database}/documents/artisans/{artisanId}
     * @allow (create) Authenticated user can create an artisan profile.
     * @allow (get, update, delete) Authenticated user can manage their own artisan profile.
     * @deny (create) If the artisanId in the request does not match the authenticated user's ID.
     * @deny (get, update, delete) If the artisanId does not match the authenticated user's ID.
     * @principle Enforces document ownership for writes.
     */
    match /artisans/{artisanId} {
      function isSignedIn() {
        return request.auth != null;
      }

        function isOwner(artisanId) {
            return request.auth.uid == artisanId;
        }

        function isExistingOwner(artisanId) {
            return isOwner(artisanId) && resource != null;
        }

        allow get: if isOwner(artisanId);
        allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == artisanId;
      allow update: if isExistingOwner(artisanId);
      allow delete: if isExistingOwner(artisanId);
    }

    /**
     * @description Controls access to training center profiles. Training centers can manage their own profiles.
     * @path /databases/{database}/documents/training-centers/{trainingCenterId}
     * @allow (create) Authenticated user can create a training center profile.
     * @allow (get, update, delete) Authenticated user can manage their own training center profile.
     * @deny (create) If the trainingCenterId in the request does not match the authenticated user's ID.
     * @deny (get, update, delete) If the trainingCenterId does not match the authenticated user's ID.
     * @principle Enforces document ownership for writes.
     */
    match /training-centers/{trainingCenterId} {
      function isSignedIn() {
        return request.auth != null;
      }

        function isOwner(trainingCenterId) {
            return request.auth.uid == trainingCenterId;
        }

        function isExistingOwner(trainingCenterId) {
            return isOwner(trainingCenterId) && resource != null;
        }

        allow get: if isOwner(trainingCenterId);
        allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == trainingCenterId;
      allow update: if isExistingOwner(trainingCenterId);
      allow delete: if isExistingOwner(trainingCenterId);
    }

    /**
     * @description Controls access to mentor profiles. Mentors can manage their own profiles.
     * @path /databases/{database}/documents/mentors/{mentorId}
     * @allow (create) Authenticated user can create a mentor profile.
     * @allow (get, update, delete) Authenticated user can manage their own mentor profile.
     * @deny (create) If the mentorId in the request does not match the authenticated user's ID.
     * @deny (get, update, delete) If the mentorId does not match the authenticated user's ID.
     * @principle Enforces document ownership for writes.
     */
    match /mentors/{mentorId} {
      function isSignedIn() {
        return request.auth != null;
      }

        function isOwner(mentorId) {
            return request.auth.uid == mentorId;
        }

        function isExistingOwner(mentorId) {
            return isOwner(mentorId) && resource != null;
        }

        allow get: if isOwner(mentorId);
        allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == mentorId;
      allow update: if isExistingOwner(mentorId);
      allow delete: if isExistingOwner(mentorId);
    }

    /**
     * @description Controls access to product data. Artisans can manage their own products.
     * @path /databases/{database}/documents/products/{productId}
     * @allow (create) Authenticated artisan can create a product.
     * @allow (get, update, delete) Authenticated artisan can manage their own products.
     * @deny (create) If the artisanId in the request does not match the authenticated user's ID.
     * @deny (get, update, delete) If the artisanId does not match the authenticated user's ID.
     * @principle Enforces document ownership for writes.
     */
    match /products/{productId} {
      function isSignedIn() {
        return request.auth != null;
      }

        function isArtisanOwner(artisanId) {
            return request.auth.uid == artisanId;
        }

        function isExistingArtisanOwner(artisanId) {
            return isArtisanOwner(artisanId) && resource != null;
        }

        allow get: if true;
        allow list: if true;
      allow create: if isSignedIn();
      allow update: if isExistingArtisanOwner(resource.data.artisanId);
      allow delete: if isExistingArtisanOwner(resource.data.artisanId);
    }

    /**
     * @description Controls access to course data. Training centers can manage their own courses.
     * @path /databases/{database}/documents/courses/{courseId}
     * @allow (create) Authenticated training center can create a course.
     * @allow (get, update, delete) Authenticated training center can manage their own courses.
     * @deny (create) If the centerId in the request does not match the authenticated user's ID.
     * @deny (get, update, delete) If the centerId does not match the authenticated user's ID.
     * @principle Enforces document ownership for writes.
     */
    match /courses/{courseId} {
      function isSignedIn() {
        return request.auth != null;
      }

        function isCenterOwner(centerId) {
            return request.auth.uid == centerId;
        }

        function isExistingCenterOwner(centerId) {
            return isCenterOwner(centerId) && resource != null;
        }

        allow get: if true;
        allow list: if true;
      allow create: if isSignedIn();
      allow update: if isExistingCenterOwner(resource.data.centerId);
      allow delete: if isExistingCenterOwner(resource.data.centerId);
    }

    /**
     * @description Controls access to order data.
     * @path /databases/{database}/documents/orders/{orderId}
     */
    match /orders/{orderId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isArtisanOwner(artisanId) {
            return request.auth.uid == artisanId;
        }

        function isExistingArtisanOwner(artisanId) {
            return isArtisanOwner(artisanId) && resource != null;
        }

        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn();
        allow update: if isExistingArtisanOwner(resource.data.artisanId);
        allow delete: if isExistingArtisanOwner(resource.data.artisanId);
    }
  }
}