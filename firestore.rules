/**
 * @file Firestore Security Rules for UmwugaHome Platform
 *
 * @core_philosophy This ruleset enforces a user-ownership model for profile data (artisans, training centers, mentors, youth).
 *  Users can only read and write their own profile data. Products and courses are publicly readable but writable only by the associated artisan or training center respectively.
 *
 * @data_structure
 * - /users/{userId}: Stores user profile information. The document ID is the user's Firebase UID.
 * - /artisans/{artisanId}: Stores artisan profiles. Contains a userId field linking it to a user.
 * - /training-centers/{trainingCenterId}: Stores training center profiles. Contains a userId field linking it to a user.
 * - /mentors/{mentorId}: Stores mentor profiles. Contains a userId field linking it to a user.
 * - /products/{productId}: Stores product information. Contains an artisanId field linking it to an artisan.
 * - /courses/{courseId}: Stores course information. Contains a centerId field linking it to a training center.
 * - /orders/{orderId}: Stores order information. Contains references to artisans, products and customers (users).
 *
 * @key_security_decisions
 * - Users can only manage their own profiles. Listing all users is disallowed.
 * - Public read access is granted to products and courses, but write access is restricted to owners (artisans and training centers, respectively).
 * - Orders are only writable by authenticated users.
 *
 * @denormalization_for_authorization
 * - Artisan, TrainingCenter, and Mentor documents contain a `userId` field to directly link them to a user's UID for ownership checks.
 * - Product documents contain an `artisanId` field to directly link them to an artisan's ID for ownership checks.
 * - Course documents contain a `centerId` field to directly link them to a training center's ID for ownership checks.
 *
 * @structural_segregation Private user data and public product/course listings are stored in separate collections.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows users to manage their own user document.
     * @path /databases/{database}/documents/users/{userId}
     * @allow (create) User with UID 'user_abc' can create their own document at /users/user_abc.
     * @deny (create) User with UID 'user_abc' cannot create a document at /users/user_xyz.
     * @allow (get) User with UID 'user_abc' can get their own document at /users/user_abc.
     * @deny (get) User with UID 'user_abc' cannot get a document at /users/user_xyz.
     * @allow (update) User with UID 'user_abc' can update their own document at /users/user_abc.
     * @deny (update) User with UID 'user_abc' cannot update a document at /users/user_xyz.
     * @allow (delete) User with UID 'user_abc' can delete their own document at /users/user_abc.
     * @deny (delete) User with UID 'user_abc' cannot delete a document at /users/user_xyz.
     * @principle Enforces document ownership for all operations on user documents.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && resource.data.id == userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows users to manage their own artisan profile.
     * @path /databases/{database}/documents/artisans/{artisanId}
     * @allow (create) User with UID 'user_abc' can create an artisan profile if artisan.userId == 'user_abc'.
     * @deny (create) User with UID 'user_abc' cannot create an artisan profile if artisan.userId != 'user_abc'.
     * @allow (get) User with UID 'user_abc' can get their artisan profile if artisan.userId == 'user_abc'.
     * @deny (get) User with UID 'user_abc' cannot get an artisan profile if artisan.userId != 'user_abc'.
     * @allow (update) User with UID 'user_abc' can update their artisan profile if artisan.userId == 'user_abc'.
     * @deny (update) User with UID 'user_abc' cannot update an artisan profile if artisan.userId != 'user_abc'.
     * @allow (delete) User with UID 'user_abc' can delete their artisan profile if artisan.userId == 'user_abc'.
     * @deny (delete) User with UID 'user_abc' cannot delete an artisan profile if artisan.userId != 'user_abc'.
     * @principle Enforces document ownership for all operations on artisan profiles.
     */
    match /artisans/{artisanId} {
      allow get: if isOwner(resource.data.userId);
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.userId) && resource.data.userId == request.resource.data.userId;
      allow delete: if isExistingOwner(resource.data.userId);
    }

    /**
     * @description Allows users to manage their own training center profile.
     * @path /databases/{database}/documents/training-centers/{trainingCenterId}
     * @allow (create) User with UID 'user_abc' can create a training center profile if trainingCenter.userId == 'user_abc'.
     * @deny (create) User with UID 'user_abc' cannot create a training center profile if trainingCenter.userId != 'user_abc'.
     * @allow (get) User with UID 'user_abc' can get their training center profile if trainingCenter.userId == 'user_abc'.
     * @deny (get) User with UID 'user_abc' cannot get a training center profile if trainingCenter.userId != 'user_abc'.
     * @allow (update) User with UID 'user_abc' can update their training center profile if trainingCenter.userId == 'user_abc'.
     * @deny (update) User with UID 'user_abc' cannot update a training center profile if trainingCenter.userId != 'user_abc'.
     * @allow (delete) User with UID 'user_abc' can delete their training center profile if trainingCenter.userId == 'user_abc'.
     * @deny (delete) User with UID 'user_abc' cannot delete a training center profile if trainingCenter.userId != 'user_abc'.
     * @principle Enforces document ownership for all operations on training center profiles.
     */
    match /training-centers/{trainingCenterId} {
      allow get: if isOwner(resource.data.userId);
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.userId)  && resource.data.userId == request.resource.data.userId;
      allow delete: if isExistingOwner(resource.data.userId);
    }

    /**
     * @description Allows users to manage their own mentor profile.
     * @path /databases/{database}/documents/mentors/{mentorId}
     * @allow (create) User with UID 'user_abc' can create a mentor profile if mentor.userId == 'user_abc'.
     * @deny (create) User with UID 'user_abc' cannot create a mentor profile if mentor.userId != 'user_abc'.
     * @allow (get) User with UID 'user_abc' can get their mentor profile if mentor.userId == 'user_abc'.
     * @deny (get) User with UID 'user_abc' cannot get a mentor profile if mentor.userId != 'user_abc'.
     * @allow (update) User with UID 'user_abc' can update their mentor profile if mentor.userId == 'user_abc'.
     * @deny (update) User with UID 'user_abc' cannot update a mentor profile if mentor.userId != 'user_abc'.
     * @allow (delete) User with UID 'user_abc' can delete their mentor profile if mentor.userId == 'user_abc'.
     * @deny (delete) User with UID 'user_abc' cannot delete a mentor profile if mentor.userId != 'user_abc'.
     * @principle Enforces document ownership for all operations on mentor profiles.
     */
    match /mentors/{mentorId} {
      allow get: if isOwner(resource.data.userId);
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.userId) && resource.data.userId == request.resource.data.userId;
      allow delete: if isExistingOwner(resource.data.userId);
    }

    /**
     * @description Allows artisans to manage their own products. Products are publicly readable.
     * @path /databases/{database}/documents/products/{productId}
     * @allow (get) Any user can read any product.
     * @allow (list) Any user can list products.
     * @allow (create) User with UID 'user_abc' can create a product if product.artisanId is a reference to their artisan profile.
     * @deny (create) User with UID 'user_abc' cannot create a product if product.artisanId is not a reference to their artisan profile.
     * @allow (update) User with UID 'user_abc' can update their product if product.artisanId is a reference to their artisan profile.
     * @deny (update) User with UID 'user_abc' cannot update a product if product.artisanId is not a reference to their artisan profile.
     * @allow (delete) User with UID 'user_abc' can delete their product if product.artisanId is a reference to their artisan profile.
     * @deny (delete) User with UID 'user_abc' cannot delete a product if product.artisanId is not a reference to their artisan profile.
     * @principle Enforces document ownership for writes on products.
     */
    match /products/{productId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && exists(/databases/$(database)/documents/artisans/$(request.resource.data.artisanId)) && get(/databases/$(database)/documents/artisans/$(request.resource.data.artisanId)).data.userId == request.auth.uid;
      allow update: if isSignedIn() && exists(/databases/$(database)/documents/artisans/$(resource.data.artisanId)) && get(/databases/$(database)/documents/artisans/$(resource.data.artisanId)).data.userId == request.auth.uid;
      allow delete: if isSignedIn() && exists(/databases/$(database)/documents/artisans/$(resource.data.artisanId)) && get(/databases/$(database)/documents/artisans/$(resource.data.artisanId)).data.userId == request.auth.uid;
    }

     /**
      * @description Allows training centers to manage their own courses. Courses are publicly readable.
      * @path /databases/{database}/documents/courses/{courseId}
      * @allow (get) Any user can read any course.
      * @allow (list) Any user can list courses.
      * @allow (create) User with UID 'user_abc' can create a course if course.centerId is a reference to their training center profile.
      * @deny (create) User with UID 'user_abc' cannot create a course if course.centerId is not a reference to their training center profile.
      * @allow (update) User with UID 'user_abc' can update their course if course.centerId is a reference to their training center profile.
      * @deny (update) User with UID 'user_abc' cannot update a course if course.centerId is not a reference to their training center profile.
      * @allow (delete) User with UID 'user_abc' can delete their course if course.centerId is a reference to their training center profile.
      * @deny (delete) User with UID 'user_abc' cannot delete a course if course.centerId is not a reference to their training center profile.
      * @principle Enforces document ownership for writes on courses.
      */
    match /courses/{courseId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && exists(/databases/$(database)/documents/training-centers/$(request.resource.data.centerId)) && get(/databases/$(database)/documents/training-centers/$(request.resource.data.centerId)).data.userId == request.auth.uid;
      allow update: if isSignedIn() && exists(/databases/$(database)/documents/training-centers/$(resource.data.centerId)) && get(/databases/$(database)/documents/training-centers/$(resource.data.centerId)).data.userId == request.auth.uid;
      allow delete: if isSignedIn() && exists(/databases/$(database)/documents/training-centers/$(resource.data.centerId)) && get(/databases/$(database)/documents/training-centers/$(resource.data.centerId)).data.userId == request.auth.uid;
    }

    /**
     * @description Allows authenticated users to create orders.  Orders are readable and writable only by the user who created them.
     * @path /databases/{database}/documents/orders/{orderId}
     * @allow (create) Any authenticated user can create an order.
     * @deny (create) Unauthenticated users cannot create orders.
     * @principle  Only authenticated users can create orders.
     */
    match /orders/{orderId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    function isSignedIn() {
      return request.auth != null;
    }
  }
}