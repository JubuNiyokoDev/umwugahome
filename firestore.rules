/**
 * @fileOverview Firestore Security Rules for UmwugaHome platform.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for profile data (users, artisans, training centers, mentors, youth).
 * Users can only create, read, update, and delete their own profile information. Public read access is allowed for products, courses and orders,
 * but write access is restricted to owners based on the artisanId or centerId.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles.  The document ID is the Firebase auth UID.
 * - /artisans/{artisanId}: Stores artisan profiles.
 * - /training-centers/{trainingCenterId}: Stores training center profiles.
 * - /mentors/{mentorId}: Stores mentor profiles.
 * - /products/{productId}: Stores product information.
 * - /courses/{courseId}: Stores course information.
 * - /orders/{orderId}: Stores order information.
 *
 * Key Security Decisions:
 * - User listing is disallowed to protect user privacy.
 * - The `users` collection enforces strict ownership: only the authenticated user can manage their own document.
 * - Other top-level collections (`artisans`, `training-centers`, `mentors`) also enforce ownership, linking back to the `users` collection via the `userId` field.
 * - Products and Courses are publicly readable, but only the associated artisan or training center can modify them.
 * - Orders are publicly readable, but only the associated artisan can modify them.
 * - Role-based access control is not implemented in this prototyping phase.
 *
 * Denormalization for Authorization:
 * - Documents in the `artisans`, `training-centers`, `mentors`, and `Youth` collections include a `userId` field that is used to link back to the corresponding user document. This avoids the need for complex queries or joins in the security rules.
 * - Documents in the `products` collection include an `artisanId` field that is used to link back to the corresponding artisan document.
 * - Documents in the `courses` collection include a `centerId` field that is used to link back to the corresponding training center document.
 * - Documents in the `orders` collection include an `artisanId` field that is used to link back to the corresponding artisan document.
 *
 * Structural Segregation:
 * - There is no explicit segregation of private vs. public data. All data is stored in a single collection for each entity type. Public read access is granted to certain collections (products, courses, orders), but write access is always restricted to the owner.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the current user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the current user is the owner of the resource, using the userId.
     * @param {string} userId The user ID to compare against the request's authentication UID.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the current user is the owner of the resource and the resource exists.
     * @param {string} userId The user ID to compare against the resource's userId.
     * @return {boolean} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for the /users collection.
     * @path /databases/{database}/documents/users/{userId}
     * @allow (create) Authenticated user can create their own user document if the UID matches the document ID.
     * @allow (get) Authenticated user can read their own user document.
     * @allow (update) Authenticated user can update their own user document.
     * @allow (delete) Authenticated user can delete their own user document.
     * @deny (create) Non-authenticated user cannot create a user document.
     * @deny (create) Authenticated user cannot create a user document with a mismatched UID.
     * @deny (get) Non-authenticated user cannot read any user document.
     * @deny (update) Non-authenticated user cannot update any user document.
     * @deny (delete) Non-authenticated user cannot delete any user document.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the /artisans collection.
     * @path /databases/{database}/documents/artisans/{artisanId}
     * @allow (create) Authenticated user can create an artisan document if the userId matches their UID.
     * @allow (get) Anyone can read any artisan document.
     * @allow (list) Anyone can list artisan documents.
     * @allow (update) Authenticated user can update their own artisan document.
     * @allow (delete) Authenticated user can delete their own artisan document.
     * @deny (create) Non-authenticated user cannot create an artisan document.
     * @deny (create) Authenticated user cannot create an artisan document with a mismatched UID.
     * @deny (update) Non-authenticated user cannot update any artisan document that they don't own.
     * @deny (delete) Non-authenticated user cannot delete any artisan document that they don't own.
     * @principle Enforces document ownership for writes, allows public reads.
     */
    match /artisans/{artisanId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.userId);
      allow delete: if isExistingOwner(resource.data.userId);
    }

    /**
     * @description Rules for the /training-centers collection.
     * @path /databases/{database}/documents/training-centers/{trainingCenterId}
     * @allow (create) Authenticated user can create a training center document if the userId matches their UID.
     * @allow (get) Anyone can read any training center document.
     * @allow (list) Anyone can list training center documents.
     * @allow (update) Authenticated user can update their own training center document.
     * @allow (delete) Authenticated user can delete their own training center document.
     * @deny (create) Non-authenticated user cannot create a training center document.
     * @deny (create) Authenticated user cannot create a training center document with a mismatched UID.
     * @deny (update) Non-authenticated user cannot update any training center document that they don't own.
     * @deny (delete) Non-authenticated user cannot delete any training center document that they don't own.
     * @principle Enforces document ownership for writes, allows public reads.
     */
    match /training-centers/{trainingCenterId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.userId);
      allow delete: if isExistingOwner(resource.data.userId);
    }

    /**
     * @description Rules for the /mentors collection.
     * @path /databases/{database}/documents/mentors/{mentorId}
     * @allow (create) Authenticated user can create a mentor document if the userId matches their UID.
     * @allow (get) Anyone can read any mentor document.
     * @allow (list) Anyone can list mentor documents.
     * @allow (update) Authenticated user can update their own mentor document.
     * @allow (delete) Authenticated user can delete their own mentor document.
     * @deny (create) Non-authenticated user cannot create a mentor document.
     * @deny (create) Authenticated user cannot create a mentor document with a mismatched UID.
     * @deny (update) Non-authenticated user cannot update any mentor document that they don't own.
     * @deny (delete) Non-authenticated user cannot delete any mentor document that they don't own.
     * @principle Enforces document ownership for writes, allows public reads.
     */
    match /mentors/{mentorId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.userId);
      allow delete: if isExistingOwner(resource.data.userId);
    }

    /**
     * @description Rules for the /youth collection.
     * @path /databases/{database}/documents/youth/{youthId}
     * @allow (create) Authenticated user can create a youth document if the userId matches their UID.
     * @allow (get) Authenticated user can read their own youth document.
     * @allow (list) Authenticated user can list their own youth documents.
     * @allow (update) Authenticated user can update their own youth document.
     * @allow (delete) Authenticated user can delete their own youth document.
     * @deny (create) Non-authenticated user cannot create a youth document.
     * @deny (create) Authenticated user cannot create a youth document with a mismatched UID.
     * @deny (get) Non-authenticated user cannot read any youth document.
     * @deny (update) Non-authenticated user cannot update any youth document.
     * @deny (delete) Non-authenticated user cannot delete any youth document.
     * @principle Enforces document ownership for all operations.
     */
    match /youth/{youthId} {
      allow get: if isOwner(youthId);
      allow list: if false;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.userId);
      allow delete: if isExistingOwner(resource.data.userId);
    }

    /**
     * @description Rules for the /products collection.
     * @path /databases/{database}/documents/products/{productId}
     * @allow (get) Anyone can read a product document.
     * @allow (list) Anyone can list product documents.
     * @allow (create) Only the artisan (owner) can create a product document with the correct artisanId.
     * @allow (update) Only the artisan (owner) can update their product document.
     * @allow (delete) Only the artisan (owner) can delete their product document.
     * @deny (create) Non-authenticated user cannot create a product document.
     * @deny (update) Non-authenticated user cannot update any product document.
     * @deny (delete) Non-authenticated user cannot delete any product document.
     * @principle Public read, owner-only writes, enforces artisanId consistency.
     */
    match /products/{productId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.artisanId != null && exists(/databases/$(database)/documents/artisans/$(request.resource.data.artisanId)) && get(/databases/$(database)/documents/artisans/$(request.resource.data.artisanId)).data.userId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.artisanId != null && exists(/databases/$(database)/documents/artisans/$(resource.data.artisanId)) && get(/databases/$(database)/documents/artisans/$(resource.data.artisanId)).data.userId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.artisanId != null && exists(/databases/$(database)/documents/artisans/$(resource.data.artisanId)) && get(/databases/$(database)/documents/artisans/$(resource.data.artisanId)).data.userId == request.auth.uid;
    }

    /**
     * @description Rules for the /courses collection.
     * @path /databases/{database}/documents/courses/{courseId}
     * @allow (get) Anyone can read a course document.
     * @allow (list) Anyone can list course documents.
     * @allow (create) Only the training center can create a course document with the correct centerId.
     * @allow (update) Only the training center can update their course document.
     * @allow (delete) Only the training center can delete their course document.
     * @deny (create) Non-authenticated user cannot create a course document.
     * @deny (update) Non-authenticated user cannot update any course document.
     * @deny (delete) Non-authenticated user cannot delete any course document.
     * @principle Public read, owner-only writes, enforces centerId consistency.
     */
    match /courses/{courseId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.centerId != null && exists(/databases/$(database)/documents/training-centers/$(request.resource.data.centerId)) && get(/databases/$(database)/documents/training-centers/$(request.resource.data.centerId)).data.userId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.centerId != null && exists(/databases/$(database)/documents/training-centers/$(resource.data.centerId)) && get(/databases/$(database)/documents/training-centers/$(resource.data.centerId)).data.userId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.centerId != null && exists(/databases/$(database)/documents/training-centers/$(resource.data.centerId)) && get(/databases/$(database)/documents/training-centers/$(resource.data.centerId)).data.userId == request.auth.uid;
    }

    /**
     * @description Rules for the /orders collection.
     * @path /databases/{database}/documents/orders/{orderId}
     * @allow (get) Anyone can read a order document.
     * @allow (list) Anyone can list order documents.
     * @allow (create) Only the artisan (owner) can create a order document with the correct artisanId.
     * @allow (update) Only the artisan (owner) can update their order document.
     * @allow (delete) Only the artisan (owner) can delete their order document.
     * @deny (create) Non-authenticated user cannot create a order document.
     * @deny (update) Non-authenticated user cannot update any order document.
     * @deny (delete) Non-authenticated user cannot delete any order document.
     * @principle Public read, owner-only writes, enforces artisanId consistency.
     */
    match /orders/{orderId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.artisanId != null && exists(/databases/$(database)/documents/artisans/$(request.resource.data.artisanId)) && get(/databases/$(database)/documents/artisans/$(request.resource.data.artisanId)).data.userId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.artisanId != null && exists(/databases/$(database)/documents/artisans/$(resource.data.artisanId)) && get(/databases/$(database)/documents/artisans/$(resource.data.artisanId)).data.userId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.artisanId != null && exists(/databases/$(database)/documents/artisans/$(resource.data.artisanId)) && get(/databases/$(database)/documents/artisans/$(resource.data.artisanId)).data.userId == request.auth.uid;
    }
  }
}